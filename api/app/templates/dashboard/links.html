{% extends "layout.html" %}

{% block title %}Manage Links - LinkCrm{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Manage Links</h2>
    <div>
        {% if link_limit %}
        <span class="badge bg-secondary me-2">
            {{ links|length }} / {{ link_limit }} links used
        </span>
        {% else %}
        <span class="badge bg-success me-2">Unlimited links</span>
        {% endif %}
        <button class="btn btn-cabernet" data-bs-toggle="modal" data-bs-target="#addLinkModal" {% if not can_add_more %}disabled{% endif %}>
            Add Link
        </button>
    </div>
</div>

{% if request.query_params.get('success') == 'created' %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    Link created successfully!
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

{% if request.query_params.get('error') == 'limit_reached' %}
<div class="alert alert-warning alert-dismissible fade show" role="alert">
    <strong>Link limit reached!</strong> You've reached the maximum of {{ request.query_params.get('limit') }} links for the {{ request.query_params.get('plan') }} plan.
    <a href="/dashboard" class="alert-link">Upgrade your plan</a> to add more links.
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<div class="card">
    <div class="card-body">
        {% if links %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th style="width: 50px"></th>
                        <th>Title</th>
                        <th>URL</th>
                        <th>Clicks</th>
                        <th>Status</th>
                        <th style="width: 150px">Actions</th>
                    </tr>
                </thead>
                <tbody id="links-list">
                    {% for link in links %}
                    <tr data-link-id="{{ link.id }}">
                        <td>
                            <span class="handle" style="cursor: move;">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                </svg>
                            </span>
                        </td>
                        <td>{{ link.title }}</td>
                        <td><a href="{{ link.url }}" target="_blank" class="text-truncate d-inline-block" style="max-width: 300px;">{{ link.url }}</a></td>
                        <td>{{ link.clicks }}</td>
                        <td>
                            {% if link.is_active %}
                            <span class="badge bg-success">Active</span>
                            {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editLink('{{ link.id }}', '{{ link.title }}', '{{ link.url }}', {{ link.is_active|lower }})">Edit</button>
                            <form method="post" action="/dashboard/links/{{ link.id }}/delete" class="d-inline">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-3 text-muted small">
            <em>Tip: Drag and drop links to reorder them</em>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted">No links yet. Add your first link to get started!</p>
            <button class="btn btn-cabernet" data-bs-toggle="modal" data-bs-target="#addLinkModal">Add Your First Link</button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Link Modal -->
<div class="modal fade" id="addLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="/dashboard/links/create">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required placeholder="e.g., My Website">
                    </div>
                    <div class="mb-3">
                        <label for="url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="url" name="url" required placeholder="https://example.com">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-cabernet">Add Link</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Link Modal -->
<div class="modal fade" id="editLinkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" id="editLinkForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Link</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="edit_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_url" class="form-label">URL</label>
                        <input type="url" class="form-control" id="edit_url" name="url" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-cabernet">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function editLink(id, title, url, isActive) {
    document.getElementById('editLinkForm').action = `/dashboard/links/${id}/update`;
    document.getElementById('edit_title').value = title;
    document.getElementById('edit_url').value = url;
    document.getElementById('edit_is_active').checked = isActive;
    new bootstrap.Modal(document.getElementById('editLinkModal')).show();
}

// Drag and drop reordering (simplified - would need sortable.js for production)
// For now, just show the handle as a visual cue
</script>

{% endblock %}
